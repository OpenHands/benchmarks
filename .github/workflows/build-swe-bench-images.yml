name: Build SWE-Bench Lite (Relay Strategy)

on:
  pull_request_target:
    types: [labeled]
  workflow_dispatch:
    inputs:
      dataset:
        default: 'princeton-nlp/SWE-bench_Lite'
      split:
        default: 'test'

env:
  DATASET: princeton-nlp/SWE-bench_Lite
  SPLIT: test
  MAX_WORKERS: '3'   # Keep low to prevent RAM crash
  N_LIMIT: ''        # Empty = Build ALL 300 images

jobs:
  # ====================================================
  # RUNNER 1: The First Leg
  # Expected to build images 1-120 before disk fills up
  # ====================================================
  batch-1:
    runs-on: ubuntu-latest
    permissions:
      packages: write
      contents: read
    steps:
      - uses: actions/checkout@v4
        with: { submodules: recursive, ref: ${{ github.event.pull_request.head.sha }} }
      
      # 1. MAXIMIZE DISK SPACE (Gives +30GB)
      - name: Free Disk Space
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: true
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          docker-images: false
          swap-storage: false

      # 2. STANDARD SETUP
      - uses: docker/login-action@v3
        with: { username: ${{ secrets.DOCKERHUB_USERNAME }}, password: ${{ secrets.DOCKERHUB_TOKEN }} }
      - uses: docker/login-action@v3
        with: { registry: ghcr.io, username: ${{ github.actor }}, password: ${{ secrets.GITHUB_TOKEN }} }
      - uses: docker/setup-buildx-action@v3
      - uses: astral-sh/setup-uv@v7
      - run: make build

      # 3. BUILD COMMAND (Will likely crash eventually)
      - name: Build Batch 1
        continue-on-error: true  # Don't mark the workflow as red if this crashes!
        run: |
          uv run benchmarks/swe_bench/build_images.py \
            --dataset '${DATASET}' --split '${SPLIT}' \
            --image ghcr.io/${{ github.repository_owner }}/eval-agent-server \
            --push --max-workers '${MAX_WORKERS}'

  # ====================================================
  # RUNNER 2: The Second Leg
  # Starts FRESH. Skips existing images. Builds 121-240.
  # ====================================================
  batch-2:
    needs: batch-1             # Waits for batch-1 to finish
    if: always()               # Runs even if batch-1 crashed!
    runs-on: ubuntu-latest
    permissions:
      packages: write
      contents: read
    steps:
      - uses: actions/checkout@v4
        with: { submodules: recursive, ref: ${{ github.event.pull_request.head.sha }} }
      - name: Free Disk Space
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: true
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          docker-images: false
          swap-storage: false

      - uses: docker/login-action@v3
        with: { username: ${{ secrets.DOCKERHUB_USERNAME }}, password: ${{ secrets.DOCKERHUB_TOKEN }} }
      - uses: docker/login-action@v3
        with: { registry: ghcr.io, username: ${{ github.actor }}, password: ${{ secrets.GITHUB_TOKEN }} }
      - uses: docker/setup-buildx-action@v3
      - uses: astral-sh/setup-uv@v7
      - run: make build

      - name: Build Batch 2 (Resume)
        continue-on-error: true
        run: |
          echo "Resuming build... Previously built images will be skipped in seconds."
          uv run benchmarks/swe_bench/build_images.py \
            --dataset '${DATASET}' --split '${SPLIT}' \
            --image ghcr.io/${{ github.repository_owner }}/eval-agent-server \
            --push --max-workers '${MAX_WORKERS}'

  # ====================================================
  # RUNNER 3: The Anchor Leg
  # Starts FRESH. Finishes whatever is left (241-300).
  # ====================================================
  batch-3:
    needs: batch-2
    if: always()
    runs-on: ubuntu-latest
    permissions:
      packages: write
      contents: read
    steps:
      - uses: actions/checkout@v4
        with: { submodules: recursive, ref: ${{ github.event.pull_request.head.sha }} }
      - name: Free Disk Space
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: true
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          docker-images: false
          swap-storage: false
      
      - uses: docker/login-action@v3
        with: { username: ${{ secrets.DOCKERHUB_USERNAME }}, password: ${{ secrets.DOCKERHUB_TOKEN }} }
      - uses: docker/login-action@v3
        with: { registry: ghcr.io, username: ${{ github.actor }}, password: ${{ secrets.GITHUB_TOKEN }} }
      - uses: docker/setup-buildx-action@v3
      - uses: astral-sh/setup-uv@v7
      - run: make build

      - name: Build Batch 3 (Final)
        run: |
          echo "Final cleanup pass..."
          uv run benchmarks/swe_bench/build_images.py \
            --dataset '${DATASET}' --split '${SPLIT}' \
            --image ghcr.io/${{ github.repository_owner }}/eval-agent-server \
            --push --max-workers '${MAX_WORKERS}'
