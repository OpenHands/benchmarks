name: Build SWE-Bench Images

on:
  # pull_request:  # for debugging
  workflow_dispatch:
    inputs:
      dataset:
        description: 'Dataset name (e.g., princeton-nlp/SWE-bench_Verified)'
        required: true
        default: 'princeton-nlp/SWE-bench_Verified'
        type: string
      split:
        description: 'Dataset split (e.g., test, dev)'
        required: true
        default: 'test'
        type: string
      max-workers:
        description: 'Number of concurrent builds'
        required: false
        default: '32'
        type: string
      n-limit:
        description: 'Limit number of images to build (for testing). Leave blank for no limit.'
        required: false
        default: ''
        type: string

# Reasonable defaults for automatic (push) runs; workflow_dispatch can override these.
env:
  DATASET: princeton-nlp/SWE-bench_Verified
  SPLIT: test
  MAX_WORKERS: '32'
  N_LIMIT: '500'

concurrency:
  group: build-swe-bench-${{ github.ref }}
  cancel-in-progress: false

jobs:
  build-and-push:
    runs-on:
      labels: blacksmith-32vcpu-ubuntu-2204

    # Allow pushing to GHCR and commenting on issues
    permissions:
      contents: read
      packages: write
      issues: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      # If this was a manual dispatch, override defaults with provided inputs.
      - name: Apply workflow_dispatch overrides (if any)
        if: ${{ github.event_name == 'workflow_dispatch' }}
        run: |
          if [ -n "${{ inputs.dataset }}" ]; then echo "DATASET=${{ inputs.dataset }}" >> "$GITHUB_ENV"; fi
          if [ -n "${{ inputs.split }}" ]; then echo "SPLIT=${{ inputs.split }}" >> "$GITHUB_ENV"; fi
          if [ -n "${{ inputs.max-workers }}" ]; then echo "MAX_WORKERS=${{ inputs.max-workers }}" >> "$GITHUB_ENV"; fi
          # Empty string means "no limit"
          if [ -n "${{ inputs.n-limit }}" ]; then echo "N_LIMIT=${{ inputs.n-limit }}" >> "$GITHUB_ENV"; else echo "N_LIMIT=" >> "$GITHUB_ENV"; fi

      - name: Set up Docker Buildx with Blacksmith
        uses: useblacksmith/setup-docker-builder@v1

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true

      - name: Install dependencies
        run: |
          make build

      - name: Build and push SWE-Bench images (attempt 1)
        run: |
          set -euo pipefail

          CMD="uv run benchmarks/swe_bench/build_images.py \
            --dataset '${DATASET}' \
            --split '${SPLIT}' \
            --image ghcr.io/openhands/eval-agent-server \
            --push \
            --max-workers '${MAX_WORKERS}'"

          # Only include --n-limit if provided (non-empty)
          if [ -n "${N_LIMIT}" ]; then
            CMD="$CMD --n-limit '${N_LIMIT}'"
          fi

          echo "Running: $CMD"
          eval "$CMD"
        env:
          DOCKER_BUILDKIT: 1
          BUILDKIT_PROGRESS: plain

      - name: Extract failed builds (attempt 1)
        if: always()
        run: |
          if .github/scripts/extract_failed_builds.sh "builds/${DATASET}/${SPLIT}/failed-attempt-1.txt"; then
            echo "RETRY_NEEDED=true" >> "$GITHUB_ENV"
          else
            echo "RETRY_NEEDED=false" >> "$GITHUB_ENV"
          fi

      - name: Preserve manifest from attempt 1
        if: always()
        run: |
          MANIFEST_FILE="builds/${DATASET}/${SPLIT}/manifest.jsonl"
          if [ -f "$MANIFEST_FILE" ]; then
            mv "$MANIFEST_FILE" "builds/${DATASET}/${SPLIT}/manifest-attempt-1.jsonl"
            echo "Preserved manifest from attempt 1"
          fi

      - name: Retry failed builds (attempt 2)
        if: env.RETRY_NEEDED == 'true'
        run: |
          set -euo pipefail
          
          FAILED_FILE="builds/${DATASET}/${SPLIT}/failed-attempt-1.txt"
          
          if [ ! -f "$FAILED_FILE" ]; then
            echo "Failed images file not found: $FAILED_FILE"
            exit 0
          fi
          
          echo "Retrying failed builds from $FAILED_FILE"
          uv run benchmarks/swe_bench/build_images.py \
            --base-images-file "$FAILED_FILE" \
            --image ghcr.io/openhands/eval-agent-server \
            --push \
            --max-workers '${MAX_WORKERS}'
        env:
          DOCKER_BUILDKIT: 1
          BUILDKIT_PROGRESS: plain

      - name: Extract failed builds (attempt 2)
        if: env.RETRY_NEEDED == 'true'
        run: |
          if .github/scripts/extract_failed_builds.sh "builds/${DATASET}/${SPLIT}/failed-attempt-2.txt"; then
            echo "RETRY_NEEDED_2=true" >> "$GITHUB_ENV"
          else
            echo "RETRY_NEEDED_2=false" >> "$GITHUB_ENV"
          fi

      - name: Preserve manifest from attempt 2
        if: env.RETRY_NEEDED == 'true'
        run: |
          MANIFEST_FILE="builds/${DATASET}/${SPLIT}/manifest.jsonl"
          if [ -f "$MANIFEST_FILE" ]; then
            mv "$MANIFEST_FILE" "builds/${DATASET}/${SPLIT}/manifest-attempt-2.jsonl"
            echo "Preserved manifest from attempt 2"
          fi

      - name: Retry failed builds (attempt 3)
        if: env.RETRY_NEEDED_2 == 'true'
        run: |
          set -euo pipefail
          
          FAILED_FILE="builds/${DATASET}/${SPLIT}/failed-attempt-2.txt"
          
          if [ ! -f "$FAILED_FILE" ]; then
            echo "Failed images file not found: $FAILED_FILE"
            exit 0
          fi
          
          echo "Retrying failed builds from $FAILED_FILE (final attempt)"
          uv run benchmarks/swe_bench/build_images.py \
            --base-images-file "$FAILED_FILE" \
            --image ghcr.io/openhands/eval-agent-server \
            --push \
            --max-workers '${MAX_WORKERS}'
        env:
          DOCKER_BUILDKIT: 1
          BUILDKIT_PROGRESS: plain

      - name: Archive build logs
        if: always()
        run: |
          if [ -d builds ]; then
            # Create tar archive to avoid filename restrictions (colons, etc.)
            tar -czf build-logs.tar.gz builds/
            echo "Build logs archived successfully"
          else
            echo "No builds directory found"
          fi

      - name: Upload build logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs-${{ github.run_id }}
          path: build-logs.tar.gz
          retention-days: 7
          if-no-files-found: warn

      - name: Display build summary
        if: always()
        run: |
          echo "## Build Summary" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          
          # Function to analyze a manifest file
          analyze_manifest() {
            local manifest_file="$1"
            local attempt_name="$2"
            
            if [ ! -f "$manifest_file" ]; then
              return
            fi
            
            local total=$(cat "$manifest_file" 2>/dev/null | wc -l)
            local successes=$(cat "$manifest_file" 2>/dev/null | python3 -c "
          import sys
          import json
          count = 0
          for line in sys.stdin:
              data = json.loads(line.strip())
              if data.get('error') is None and len(data.get('tags', [])) > 0:
                  count += 1
          print(count)
          ")
            local failures=$((total - successes))
            
            echo "### $attempt_name" >> "$GITHUB_STEP_SUMMARY"
            echo "- **Total:** $total" >> "$GITHUB_STEP_SUMMARY"
            echo "- **Successful:** ✅ $successes" >> "$GITHUB_STEP_SUMMARY"
            echo "- **Failed:** ❌ $failures" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
          }
          
          # Analyze each attempt's manifest
          BUILD_DIR="builds/${DATASET}/${SPLIT}"
          
          if [ -f "$BUILD_DIR/manifest-attempt-1.jsonl" ]; then
            analyze_manifest "$BUILD_DIR/manifest-attempt-1.jsonl" "Attempt 1"
          fi
          
          if [ -f "$BUILD_DIR/manifest-attempt-2.jsonl" ]; then
            analyze_manifest "$BUILD_DIR/manifest-attempt-2.jsonl" "Attempt 2 (Retry)"
          fi
          
          if [ -f "$BUILD_DIR/manifest.jsonl" ]; then
            # Check if this is from attempt 3 or if no retries happened
            if [ -f "$BUILD_DIR/manifest-attempt-2.jsonl" ]; then
              analyze_manifest "$BUILD_DIR/manifest.jsonl" "Attempt 3 (Final Retry)"
            elif [ -f "$BUILD_DIR/manifest-attempt-1.jsonl" ]; then
              analyze_manifest "$BUILD_DIR/manifest.jsonl" "Attempt 2 (Retry)"
            else
              analyze_manifest "$BUILD_DIR/manifest.jsonl" "Build Results"
            fi
          fi
          
          # Show final failed builds if any (from the latest manifest)
          FINAL_MANIFEST="$BUILD_DIR/manifest.jsonl"
          if [ -f "$FINAL_MANIFEST" ]; then
            FINAL_FAILURES=$(cat "$FINAL_MANIFEST" 2>/dev/null | python3 -c "
          import sys
          import json
          count = 0
          for line in sys.stdin:
              data = json.loads(line.strip())
              if data.get('error') is not None or len(data.get('tags', [])) == 0:
                  count += 1
          print(count)
          ")
            
            if [ "$FINAL_FAILURES" -gt 0 ]; then
              echo "### ❌ Remaining Failed Builds" >> "$GITHUB_STEP_SUMMARY"
              echo "" >> "$GITHUB_STEP_SUMMARY"
              cat "$FINAL_MANIFEST" | python3 -c "
          import sys
          import json
          for line in sys.stdin:
              data = json.loads(line.strip())
              if data.get('error') is not None or len(data.get('tags', [])) == 0:
                  error_msg = data.get('error', 'No tags generated')
                  # Truncate long error messages
                  if len(error_msg) > 100:
                      error_msg = error_msg[:100] + '...'
                  print(f\"- \\\`{data.get('base_image', 'unknown')}\\\`: {error_msg}\")
          " >> "$GITHUB_STEP_SUMMARY"
            else
              echo "### ✅ All Builds Successful!" >> "$GITHUB_STEP_SUMMARY"
              echo "" >> "$GITHUB_STEP_SUMMARY"
            fi
          fi

      - name: Comment on tracker issue
        if: success()
        run: |
          # Get SDK version from submodule
          SDK_SHA=$(git submodule status vendor/software-agent-sdk | awk '{print $1}' | sed 's/^[+-]//')
          
          # Find all manifest.jsonl files
          MANIFEST_FILES=$(find builds -name "manifest.jsonl" -type f 2>/dev/null)
          
          if [ -z "$MANIFEST_FILES" ]; then
            echo "No manifest.jsonl files found in builds directory"
            echo "Build may have completed but produced no images"
            exit 0
          fi
          
          # Count total images built
          TOTAL_IMAGES=$(cat $MANIFEST_FILES 2>/dev/null | wc -l)
          
          if [ "$TOTAL_IMAGES" -eq 0 ]; then
            echo "No images found in manifest files"
            echo "Skipping comment as there are no built images to report"
            exit 0
          fi
          
          # Extract all tags and format them as a markdown list (one tag per image)
          TAGS=$(cat $MANIFEST_FILES | python -c "
          import sys
          import json
          for line in sys.stdin:
              data = json.loads(line.strip())
              if data.get('tags') and len(data['tags']) > 0:
                  # Only show the first tag per image to reduce clutter
                  print(f'- \`{data[\"tags\"][0]}\`')
          ")
          
          # Determine how the workflow was triggered
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            TRIGGER="Manual trigger (workflow_dispatch)"
          elif [ "${{ github.event_name }}" = "pull_request" ]; then
            TRIGGER="Pull request [#${{ github.event.pull_request.number }}](${{ github.event.pull_request.html_url }})"
          else
            TRIGGER="${{ github.event_name }}"
          fi
          
          # Create the comment body
          COMMENT_BODY=$(cat <<EOF
          ## Build Complete ✅

          **Dataset:** \`${DATASET}\`
          **Split:** \`${SPLIT}\`
          **SDK Version:** [\`${SDK_SHA:0:7}\`](https://github.com/OpenHands/software-agent-sdk/commit/${SDK_SHA})
          **Workflow Run:** [#${{ github.run_id }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          **Triggered by:** ${TRIGGER}

          <details>
          <summary>Built Tags (${TOTAL_IMAGES} images)</summary>

          ${TAGS}

          </details>
          EOF
          )
          
          # Post comment to issue #81
          curl -L -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "${{ github.api_url }}/repos/${{ github.repository }}/issues/81/comments" \
            -d "$(jq -n --arg body "$COMMENT_BODY" '{body: $body}')"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
