name: Build SWE-Bench Images

on:
  pull_request:  # for debugging
  workflow_dispatch:
    inputs:
      dataset:
        description: 'Dataset name (e.g., princeton-nlp/SWE-bench_Verified)'
        required: true
        default: 'princeton-nlp/SWE-bench_Verified'
        type: string
      split:
        description: 'Dataset split (e.g., test, dev)'
        required: true
        default: 'test'
        type: string
      target:
        description: 'Build target (source | source-minimal | binary | binary-minimal)'
        required: false
        default: 'source-minimal'
        type: choice
        options:
          - source
          - source-minimal
          - binary
          - binary-minimal
      platforms:
        description: 'Comma-separated platforms (e.g., linux/amd64,linux/arm64)'
        required: false
        default: 'linux/amd64'
        type: string
      max-workers:
        description: 'Number of concurrent builds'
        required: false
        default: '2'
        type: string
      n-limit:
        description: 'Limit number of images to build (for testing). Leave blank for no limit.'
        required: false
        default: '10'
        type: string

# Reasonable defaults for automatic (push) runs; workflow_dispatch can override these.
env:
  DATASET: princeton-nlp/SWE-bench_Verified
  SPLIT: test
  TARGET: source-minimal
  PLATFORMS: linux/amd64
  MAX_WORKERS: '2'      # modest concurrency for reliability
  N_LIMIT: '10'           # empty = no limit

concurrency:
  group: build-swe-bench-${{ github.ref }}
  cancel-in-progress: false

jobs:
  build-and-push:
    runs-on:
      labels: blacksmith-32vcpu-ubuntu-2204

    # Allow pushing to GHCR
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      # If this was a manual dispatch, override defaults with provided inputs.
      - name: Apply workflow_dispatch overrides (if any)
        if: ${{ github.event_name == 'workflow_dispatch' }}
        run: |
          if [ -n "${{ inputs.dataset }}" ]; then echo "DATASET=${{ inputs.dataset }}" >> "$GITHUB_ENV"; fi
          if [ -n "${{ inputs.split }}" ]; then echo "SPLIT=${{ inputs.split }}" >> "$GITHUB_ENV"; fi
          if [ -n "${{ inputs.target }}" ]; then echo "TARGET=${{ inputs.target }}" >> "$GITHUB_ENV"; fi
          if [ -n "${{ inputs.platforms }}" ]; then echo "PLATFORMS=${{ inputs.platforms }}" >> "$GITHUB_ENV"; fi
          if [ -n "${{ inputs.max-workers }}" ]; then echo "MAX_WORKERS=${{ inputs.max-workers }}" >> "$GITHUB_ENV"; fi
          # Empty string means "no limit"
          if [ -n "${{ inputs.n-limit }}" ]; then echo "N_LIMIT=${{ inputs.n-limit }}" >> "$GITHUB_ENV"; else echo "N_LIMIT=" >> "$GITHUB_ENV"; fi

      - name: Set up Docker Buildx with Blacksmith
        uses: useblacksmith/setup-docker-builder@v1

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true

      - name: Apply fix for Docker cache tag length limit
        run: |
          cd vendor/software-agent-sdk
          git apply ../../.github/workflows/fix-cache-tag-length.patch
          echo "Applied patch to fix cache tag length limit"

      - name: Install dependencies
        run: |
          make build

      - name: Build and push SWE-Bench images
        run: |
          set -euo pipefail

          CMD="uv run benchmarks/swe_bench/build_images.py \
            --dataset '${DATASET}' \
            --split '${SPLIT}' \
            --image ghcr.io/openhands/eval-agent-server \
            --target '${TARGET}' \
            --platforms '${PLATFORMS}' \
            --push \
            --max-workers '${MAX_WORKERS}'"

          # Only include --n-limit if provided (non-empty)
          if [ -n "${N_LIMIT}" ]; then
            CMD="$CMD --n-limit '${N_LIMIT}'"
          fi

          echo "Running: $CMD"
          eval "$CMD"
        env:
          DOCKER_BUILDKIT: 1
          BUILDKIT_PROGRESS: plain

      - name: Upload build manifest
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-manifest-${{ github.run_id }}
          path: |
            builds/**/manifest.jsonl
            builds/**/summary.json
          retention-days: 30

      - name: Archive build logs
        if: always()
        run: |
          if [ -d builds ]; then
            # Create tar archive to avoid filename restrictions (colons, etc.)
            tar -czf build-logs.tar.gz builds/
            echo "Build logs archived successfully"
          else
            echo "No builds directory found"
          fi

      - name: Upload build logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs-${{ github.run_id }}
          path: build-logs.tar.gz
          retention-days: 7
          if-no-files-found: warn

      - name: Display build summary
        if: always()
        run: |
          if ls builds/*/summary.json >/dev/null 2>&1; then
            echo "## Build Summary" >> "$GITHUB_STEP_SUMMARY"
            cat builds/*/summary.json | python -m json.tool >> "$GITHUB_STEP_SUMMARY"
          fi
