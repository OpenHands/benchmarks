name: Build SWE-Bench Lite (Relay Strategy)

on:
  pull_request_target:
    types: [labeled]
  workflow_dispatch:
    inputs:
      dataset:
        description: 'Dataset Name'
        required: true
        default: 'princeton-nlp/SWE-bench_Lite'
      split:
        description: 'Split Name'
        required: true
        default: 'test'

env:
  DATASET: princeton-nlp/SWE-bench_Lite
  SPLIT: test
  MAX_WORKERS: '3'
  N_LIMIT: ''

jobs:
  batch-1:
    runs-on: ubuntu-latest
    permissions:
      packages: write
      contents: read
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
          ref: ${{ github.event.pull_request.head.sha }}
      
      - name: Free Disk Space
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: true
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          docker-images: false
          swap-storage: false

      - uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      
      - uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - uses: docker/setup-buildx-action@v3
      - uses: astral-sh/setup-uv@v7
      - run: make build

      - name: Build Batch 1
        continue-on-error: true
        run: |
          uv run benchmarks/swe_bench/build_images.py \
            --dataset "${DATASET}" \
            --split "${SPLIT}" \
            --image ghcr.io/${{ github.repository_owner }}/eval-agent-server \
            --push \
            --max-workers "${MAX_WORKERS}"

  batch-2:
    needs: batch-1
    if: always()
    runs-on: ubuntu-latest
    permissions:
      packages: write
      contents: read
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
          ref: ${{ github.event.pull_request.head.sha }}
      
      - name: Free Disk Space
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: true
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          docker-images: false
          swap-storage: false

      - uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      
      - uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - uses: docker/setup-buildx-action@v3
      - uses: astral-sh/setup-uv@v7
      - run: make build

      - name: Build Batch 2 (Resume)
        continue-on-error: true
        run: |
          echo "Resuming build..."
          uv run benchmarks/swe_bench/build_images.py \
            --dataset "${DATASET}" \
            --split "${SPLIT}" \
            --image ghcr.io/${{ github.repository_owner }}/eval-agent-server \
            --push \
            --max-workers "${MAX_WORKERS}"

  batch-3:
    needs: batch-2
    if: always()
    runs-on: ubuntu-latest
    permissions:
      packages: write
      contents: read
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
          ref: ${{ github.event.pull_request.head.sha }}
      
      - name: Free Disk Space
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: true
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          docker-images: false
          swap-storage: false
      
      - uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      
      - uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - uses: docker/setup-buildx-action@v3
      - uses: astral-sh/setup-uv@v7
      - run: make build

      - name: Build Batch 3 (Final)
        run: |
          echo "Final cleanup pass..."
          uv run benchmarks/swe_bench/build_images.py \
            --dataset "${DATASET}" \
            --split "${SPLIT}" \
            --image ghcr.io/${{ github.repository_owner }}/eval-agent-server \
            --push \
            --max-workers "${MAX_WORKERS}"
