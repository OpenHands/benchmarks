name: Build SWT-Bench Eval Images

on:
  workflow_dispatch:
    inputs:
      dataset:
        description: "Dataset name"
        required: true
        default: "eth-sri/SWT-bench_Verified_bm25_27k_zsp"
        type: string
      split:
        description: "Dataset split"
        required: true
        default: "test"
        type: string
      eval-limit:
        description: "Number of instances to match inference sampling (0 to disable)"
        required: false
        default: "1"
        type: string
      instance-ids:
        description: "Comma-separated instance IDs to force (overrides eval-limit)"
        required: false
        default: ""
        type: string
      image-prefix:
        description: "Registry prefix for pushed images"
        required: false
        default: "ghcr.io/openhands/swtbench-eval"
        type: string
      max-workers:
        description: "Maximum parallel env builds"
        required: false
        default: "4"
        type: string
      build-mode:
        description: "swt-bench build mode"
        required: false
        default: "api"
        type: choice
        options:
          - api
          - cli

concurrency:
  group: build-swtbench-eval-${{ github.ref }}
  cancel-in-progress: false

jobs:
  build:
    runs-on:
      labels: blacksmith-32vcpu-ubuntu-2204
    permissions:
      contents: read
      packages: write
      actions: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          submodules: recursive

      - name: Set up Docker Buildx
        uses: useblacksmith/setup-docker-builder@v1

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true

      - name: Install dependencies
        run: make build

      - name: Build and push prebaked eval env images
        env:
          DATASET: ${{ inputs.dataset }}
          SPLIT: ${{ inputs.split }}
          EVAL_LIMIT: ${{ inputs.eval-limit }}
          INSTANCE_IDS: ${{ inputs.instance-ids }}
          IMAGE_PREFIX: ${{ inputs.image-prefix }}
          MAX_WORKERS: ${{ inputs.max-workers }}
          BUILD_MODE: ${{ inputs.build-mode }}
        run: |
          set -euo pipefail
          ARGS=(--dataset "${DATASET}" --split "${SPLIT}" --image-prefix "${IMAGE_PREFIX}" --max-workers "${MAX_WORKERS}" --build-mode "${BUILD_MODE}")
          if [ -n "${INSTANCE_IDS}" ]; then
            ARGS+=(--instance-ids "${INSTANCE_IDS}")
          else
            ARGS+=(--eval-limit "${EVAL_LIMIT}")
          fi
          uv run swtbench-build-eval-images "${ARGS[@]}"

      - name: Make image package public (best-effort)
        if: github.repository_owner == 'OpenHands'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          IMAGE_PREFIX: ${{ inputs.image-prefix }}
        run: |
          set -euo pipefail
          NAME=$(echo "${IMAGE_PREFIX}" | awk -F/ '{print $NF}')
          if [ -z "$NAME" ]; then
            echo "No package name derived from IMAGE_PREFIX=${IMAGE_PREFIX}, skipping visibility update"
            exit 0
          fi
          gh api -X PATCH \
            -H "Accept: application/vnd.github+json" \
            /user/packages/container/${NAME}/visibility \
            -f visibility=public || echo "Warning: failed to set package visibility"
