name: Build GAIA Images

# Workflow for building universal GAIA evaluation agent server images
# Updated: 2025-12-04 - Force workflow cache refresh
on:
  pull_request_target:
    types: [labeled]
  workflow_dispatch:
    inputs:
      sdk-commit:
        description: 'Software Agent SDK commit/ref to use'
        required: true
        type: string
      target:
        description: 'Build target (default: binary-minimal)'
        required: false
        default: 'binary-minimal'
        type: choice
        options:
          - binary-minimal
          - source-minimal

concurrency:
  group: build-gaia-${{ github.ref }}
  cancel-in-progress: false

jobs:
  build-and-push:
    if: >
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'pull_request_target' &&
       github.event.label.name == 'build-gaia')

    runs-on:
      labels: ubuntu-latest

    permissions:
      contents: read
      packages: write
      issues: write

    steps:
      - name: Determine checkout ref
        id: checkout-ref
        run: |
          if [ -n "${{ github.event.pull_request.head.sha }}" ]; then
            echo "ref=${{ github.event.pull_request.head.sha }}" >> "$GITHUB_OUTPUT"
            echo "Using PR head SHA: ${{ github.event.pull_request.head.sha }}"
          else
            echo "ref=" >> "$GITHUB_OUTPUT"
            echo "Using default ref (the commit that triggered this workflow)"
          fi

      - uses: actions/checkout@v4
        with:
          ref: ${{ steps.checkout-ref.outputs.ref }}
          submodules: recursive

      - name: Update SDK submodule
        if: ${{ github.event_name == 'workflow_dispatch' && inputs.sdk-commit != '' }}
        run: |
          cd vendor/software-agent-sdk
          git fetch origin ${{ inputs.sdk-commit }}
          git checkout FETCH_HEAD
          SDK_SHA=$(git rev-parse HEAD)
          cd ../..
          git add vendor/software-agent-sdk
          echo "Updated SDK submodule to $SDK_SHA (from ${{ inputs.sdk-commit }})"

      - name: Set up Docker Buildx with Blacksmith
        uses: useblacksmith/setup-docker-builder@v1

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true

      - name: Install dependencies
        run: |
          make build

      - name: Build and push GAIA image
        run: |
          set -euo pipefail

          TARGET="${{ inputs.target || 'binary-minimal' }}"

          CMD="uv run benchmarks/gaia/build_images.py \
            --image ghcr.io/openhands/eval-agent-server \
            --target ${TARGET} \
            --push"

          echo "Running: $CMD"
          eval "$CMD"
        env:
          DOCKER_BUILDKIT: 1
          BUILDKIT_PROGRESS: plain

      - name: Build and push GAIA image with MCP pre-installed
        run: |
          set -euo pipefail

          # Get the SDK commit SHA for tagging
          SDK_SHA=$(git submodule status vendor/software-agent-sdk | awk '{print $1}' | sed 's/^[+-]//' | cut -c1-7)
          TARGET="${{ inputs.target || 'binary-minimal' }}"
          BASE_IMAGE="ghcr.io/openhands/eval-agent-server:${SDK_SHA}-gaia-${TARGET}"
          MCP_IMAGE="ghcr.io/openhands/eval-agent-server:${SDK_SHA}-gaia-${TARGET}-with-mcp"

          echo "Building MCP-enhanced image..."
          echo "  Base image: ${BASE_IMAGE}"
          echo "  MCP image:  ${MCP_IMAGE}"

          # Build the derived image with MCP pre-cached
          docker build \
            -f benchmarks/gaia/Dockerfile.gaia \
            --build-arg SDK_IMAGE="${BASE_IMAGE}" \
            -t "${MCP_IMAGE}" \
            .

          # Push the image
          docker push "${MCP_IMAGE}"

          echo "✅ MCP-enhanced image built and pushed: ${MCP_IMAGE}"
        env:
          DOCKER_BUILDKIT: 1
          BUILDKIT_PROGRESS: plain

      - name: Archive build logs
        if: always()
        run: |
          if [ -d builds ]; then
            tar -czf build-logs.tar.gz builds/
            echo "Build logs archived successfully"
          else
            echo "No builds directory found"
          fi

      - name: Upload build logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs-${{ github.run_id }}
          path: build-logs.tar.gz
          retention-days: 7
          if-no-files-found: warn

      - name: Display build summary
        if: always()
        run: |
          # GAIA builds a single universal image, so we just show success/failure
          MANIFEST_FILE=$(find builds -name "manifest.jsonl" -type f 2>/dev/null | head -1 || true)

          if [ -z "$MANIFEST_FILE" ]; then
            echo "## Build Summary" >> "$GITHUB_STEP_SUMMARY"
            echo "❌ Build failed - no manifest found" >> "$GITHUB_STEP_SUMMARY"
            exit 0
          fi

          # Read the single line from the manifest
          BUILD_DATA=$(cat "$MANIFEST_FILE")

          echo "## GAIA Image Build Summary" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"

          # Check if build succeeded
          if echo "$BUILD_DATA" | python3 -c "import sys, json; data = json.loads(sys.stdin.read()); sys.exit(0 if data.get('error') is None and len(data.get('tags', [])) > 0 else 1)"; then
            TAGS=$(echo "$BUILD_DATA" | python3 -c "import sys, json; data = json.loads(sys.stdin.read()); print('\n'.join([f'- \`{tag}\`' for tag in data.get('tags', [])]))")
            echo "✅ **Build Successful**" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "**Built Image:**" >> "$GITHUB_STEP_SUMMARY"
            echo "$TAGS" >> "$GITHUB_STEP_SUMMARY"
          else
            ERROR=$(echo "$BUILD_DATA" | python3 -c "import sys, json; data = json.loads(sys.stdin.read()); print(data.get('error', 'Unknown error'))")
            echo "❌ **Build Failed**" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "**Error:** $ERROR" >> "$GITHUB_STEP_SUMMARY"
          fi

      - name: Comment on tracker issue
        if: success()
        run: |
          # Get SDK version
          SDK_SHA=$(git submodule status vendor/software-agent-sdk | awk '{print $1}' | sed 's/^[+-]//')
          SDK_SHA_SHORT=${SDK_SHA:0:7}

          # Read the single manifest file
          MANIFEST_FILE=$(find builds -name "manifest.jsonl" -type f 2>/dev/null | head -1 || true)

          if [ -z "$MANIFEST_FILE" ]; then
            echo "No manifest file found"
            exit 0
          fi

          # Extract the image tag from the manifest
          IMAGE_TAG=$(cat "$MANIFEST_FILE" | python3 -c "
import sys, json
data = json.loads(sys.stdin.read())
tags = data.get('tags', [])
print(tags[0] if tags else 'unknown')
          ")

          if [ "$IMAGE_TAG" = "unknown" ]; then
            echo "No valid image tag found in manifest"
            exit 0
          fi

          # Construct MCP image tag
          TARGET="${{ inputs.target || 'binary-minimal' }}"
          MCP_IMAGE_TAG="ghcr.io/openhands/eval-agent-server:${SDK_SHA_SHORT}-gaia-${TARGET}-with-mcp"

          # Determine trigger source
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            TRIGGER="Manual trigger (workflow_dispatch)"
          elif [ "${{ github.event_name }}" = "pull_request" ]; then
            TRIGGER="Pull request [#${{ github.event.pull_request.number }}](${{ github.event.pull_request.html_url }})"
          else
            TRIGGER="${{ github.event_name }}"
          fi

          # Post comment
          COMMENT_BODY=$(cat <<EOF
## GAIA Image Build Complete ✅

**SDK Version:** [\`${SDK_SHA_SHORT}\`](https://github.com/OpenHands/software-agent-sdk/commit/${SDK_SHA})
**Base Image:** \`${IMAGE_TAG}\`
**MCP Image:** \`${MCP_IMAGE_TAG}\` ⚡ _(MCP server pre-cached)_
**Workflow Run:** [#${{ github.run_id }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
**Triggered by:** ${TRIGGER}

The MCP-enhanced image includes pre-cached \`mcp-server-fetch\` to eliminate 1-18 minute startup delays.
EOF
          )

          curl -L -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "${{ github.api_url }}/repos/${{ github.repository }}/issues/81/comments" \
            -d "$(jq -n --arg body "$COMMENT_BODY" '{body: $body}')"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
