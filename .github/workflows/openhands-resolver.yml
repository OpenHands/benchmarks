name: OpenHands Issue Resolver

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  pull_request_review:
    types: [submitted]

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  check-mention:
    name: Check for Valid Mention
    runs-on: ubuntu-latest
    outputs:
      should_trigger: ${{ steps.check.outputs.should_trigger }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true

      - name: Install dependencies
        run: uv sync --frozen

      - name: Check if mention is in unquoted text
        id: check
        env:
          COMMENT_BODY: ${{ github.event.comment.body || github.event.review.body || '' }}
          AUTHOR_ASSOCIATION: ${{ github.event.comment.author_association || github.event.review.author_association || '' }}
        run: |
          # Check if user has permission to trigger the bot
          if [[ "$AUTHOR_ASSOCIATION" != "OWNER" && "$AUTHOR_ASSOCIATION" != "COLLABORATOR" && "$AUTHOR_ASSOCIATION" != "MEMBER" ]]; then
            echo "User does not have permission to trigger bot"
            echo "should_trigger=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Check if mention is in unquoted text
          if uv run python benchmarks/scripts/check_mention.py "$COMMENT_BODY" "@openhands"; then
            echo "Mention found in unquoted text - will trigger bot"
            echo "should_trigger=true" >> $GITHUB_OUTPUT
          else
            echo "Mention only in quoted text or not found - will not trigger bot"
            echo "should_trigger=false" >> $GITHUB_OUTPUT
          fi

  call-resolver:
    name: Run OpenHands Resolver
    needs: check-mention
    if: needs.check-mention.outputs.should_trigger == 'true'
    uses: All-Hands-AI/OpenHands/.github/workflows/openhands-resolver.yml@main
    with:
      max_iterations: 50
      macro: "@openhands"
      target_branch: "main"
      pr_type: "draft"
      LLM_MODEL: "anthropic/claude-sonnet-4-20250514"
    secrets:
      LLM_API_KEY: ${{ secrets.LLM_API_KEY }}
      LLM_BASE_URL: ${{ secrets.LLM_BASE_URL }}
      PAT_TOKEN: ${{ secrets.PAT_TOKEN }}
      PAT_USERNAME: ${{ secrets.PAT_USERNAME }}
