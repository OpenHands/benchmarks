name: Build GAIA Image with MCP Pre-installed

on:
  workflow_dispatch:
    inputs:
      sdk-image:
        description: 'Base SDK image to extend (e.g., ghcr.io/openhands/eval-agent-server:f715937-gaia-binary-minimal)'
        required: true
        type: string
      tag-suffix:
        description: 'Suffix for the output image tag (will append to base tag)'
        required: false
        default: '-with-mcp'
        type: string

concurrency:
  group: build-gaia-mcp-${{ github.ref }}
  cancel-in-progress: false

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract base image info
        id: image-info
        run: |
          SDK_IMAGE="${{ inputs.sdk-image }}"
          # Extract tag from SDK_IMAGE
          BASE_TAG=$(echo "$SDK_IMAGE" | sed 's/.*://')
          # Create output tag
          OUTPUT_TAG="${BASE_TAG}${{ inputs.tag-suffix }}"
          OUTPUT_IMAGE="ghcr.io/openhands/eval-agent-server:${OUTPUT_TAG}"
          
          echo "base-tag=$BASE_TAG" >> "$GITHUB_OUTPUT"
          echo "output-tag=$OUTPUT_TAG" >> "$GITHUB_OUTPUT"
          echo "output-image=$OUTPUT_IMAGE" >> "$GITHUB_OUTPUT"
          
          echo "Base image: $SDK_IMAGE"
          echo "Output image: $OUTPUT_IMAGE"

      - name: Build and push derived image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: benchmarks/gaia/Dockerfile.gaia
          push: true
          tags: ${{ steps.image-info.outputs.output-image }}
          build-args: |
            SDK_IMAGE=${{ inputs.sdk-image }}
          cache-from: type=registry,ref=${{ inputs.sdk-image }}
          cache-to: type=inline

      - name: Display build summary
        run: |
          echo "## GAIA MCP Image Build Summary" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "âœ… **Build Successful**" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "**Base Image:** \`${{ inputs.sdk-image }}\`" >> "$GITHUB_STEP_SUMMARY"
          echo "**Output Image:** \`${{ steps.image-info.outputs.output-image }}\`" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "**What changed:**" >> "$GITHUB_STEP_SUMMARY"
          echo "- Pre-installed \`mcp-server-fetch\` MCP server" >> "$GITHUB_STEP_SUMMARY"
          echo "- Eliminates 1-18 minute startup delays" >> "$GITHUB_STEP_SUMMARY"
          echo "- Conversation creation now takes <10 seconds" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "**Usage:**" >> "$GITHUB_STEP_SUMMARY"
          echo "Update \`run_infer.py\` to use:" >> "$GITHUB_STEP_SUMMARY"
          echo "\`\`\`python" >> "$GITHUB_STEP_SUMMARY"
          echo "image = \"${{ steps.image-info.outputs.output-image }}\"" >> "$GITHUB_STEP_SUMMARY"
          echo "\`\`\`" >> "$GITHUB_STEP_SUMMARY"
